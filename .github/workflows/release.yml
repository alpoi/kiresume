name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: Type of version bump
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Increment version
        run: ./scripts/increment-version.sh ${{ github.event.inputs.bump }}
      
      - name: Setup typst
        uses: typst-community/setup-typst@v3
        with:
          typst-version: latest

      - name: Compile examples
        run: ./scripts/compile-examples.sh
      
      - name: Commit and tag changes
        run: |
          git config user.name "alpoi [bot]"
          git config user.email "me@angus.buzz"
          git add .
          git commit -m "ðŸš€ $NEW_VERSION"
          git push origin main
          git tag -a "v$NEW_VERSION" -m "ðŸš€ $NEW_VERSION"
          git push origin "v$NEW_VERSION"

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v$NEW_VERSION" 