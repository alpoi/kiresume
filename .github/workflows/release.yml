name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: Type of version bump
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Increment version
        id: version
        run: |
          CURRENT_VERSION=$(grep -oP '(?<=version = ")[^"]*' typst.toml)
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          case "${{ github.event.inputs.bump }}" in
            patch)
              patch=$((patch + 1))
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
          esac
          NEW_VERSION="$major.$minor.$patch"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          sed -i "s|version = \"$CURRENT_VERSION\"|version = \"$NEW_VERSION\"|" typst.toml
          sed -i "s|@preview/kiresume:$CURRENT_VERSION|@preview/kiresume:$NEW_VERSION|" README.md
          sed -i "s|@preview/kiresume:$CURRENT_VERSION|@preview/kiresume:$NEW_VERSION|" template/main.typ
      
      - name: Setup typst
        uses: typst-community/setup-typst@v3
        with:
          typst-version: latest

      - name: Compile examples
        run: |
          typst compile --root ./ examples/example.typ examples/example.pdf
          typst compile --root ./ examples/example.typ examples/example.png
          typst compile --root ./ examples/example.typ examples/example.svg
      
      - name: Commit and tag changes
        run: |
          git config user.name "alpoi [bot]"
          git config user.email "me@angus.buzz"
          git add .
          git commit -m "ðŸš€ $NEW_VERSION"
          git push origin main
          git tag -a "v$NEW_VERSION" -m "ðŸš€ $NEW_VERSION"
          git push origin "v$NEW_VERSION"
